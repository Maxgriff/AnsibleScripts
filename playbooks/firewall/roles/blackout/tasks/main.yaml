# Do a network blackout on linux

- name: Do stuff on Linux
  block:
  - name: gather linux packages
    ansible.builtin.package_facts:
      manager: auto
      strategy: first

  - name: Use Firewalld
    block:
    - name: use firewalld to add team IPs
      ansible.posix.firewalld:
        permanent: true
        source: "{{ item }}"
        zone: "trusted"
        state: "enabled"
      loop: "{{ team_ips }}"

    - name: use firewalld to block everything but ssh
      ansible.posix.firewalld:
        permanent: true
        port: "22"
        state: "enabled"
        zone: "trusted"

    - name: use firewalld to change default zone to DROP
      ansible.posix.firewalld:
        permanent: true
        zone: "public"
        state: "present"
        target: "DROP"

    - name: reload firewalld
      ansible.builtin.systemd_service:
        state: "reloaded"
        name: "firewalld"
    
    when: '"firewalld" in ansible_facts.packages'

  - name: Do stuff with iptables
    when: '"iptables" in ansible_facts.packages'
    block:
    - name: flush current rules
      ansible.builtin.iptables:
        flush: true

    - name: use iptables to only allow team IPs into network
      ansible.builtin.iptables:
        action: "append"
        chain: "INPUT"
        destination_port: "22"
        source: "{{ item }}"
        jump: "ACCEPT"
        protocol: "tcp"
        state: "present"
      loop: "{{ team_ips }}"

    - name: reload iptables
      ansible.builtin.systemd_service:
        state: "reloaded"
        name: "iptables"
  when: ansible_system | lower == "linux"

- name: do stuff in windows
  when: ansible_system | lower == "windows"
  block: 
  - name: Allow team IPs into windows
    community.windows.win_firewall_rule:
      description: "Allow team machines into local machine"
      remoteip: "{{ item }}"
    loop: "{{ team_ips }}"
